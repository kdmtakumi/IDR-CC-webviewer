{% extends "layout.html" %}

{% block title %}Supramolecular{% endblock %}

{% block content %}
  <h1>Supramolecular interactions</h1>
  <p class="dataset-note">
    BioGRID (multi-validated) + STRING (&gt;700). IDR/CC rule: one partner meets the IDR threshold, the other meets the CC threshold (order-agnostic).
  </p>

  <div class="filters">
    <form method="get" action="{{ url_for('supramolecular') }}" class="filter-form">
      <div class="filter-card">
        <h3>IDR / CC filter (canonical style)</h3>
        <div class="filter-row filter-row-primary">
          <label for="idr_len_min">IDR length (aa) ≥</label>
          <input type="number" id="idr_len_min" name="idr_len_min" min="0" value="{{ min_idr_len if min_idr_len is not none else '' }}" placeholder="e.g. 100" />
          <label for="cc_len_min">CC length (aa) ≥</label>
          <input type="number" id="cc_len_min" name="cc_len_min" min="0" value="{{ min_cc_len if min_cc_len is not none else '' }}" placeholder="e.g. 50" />
          <label for="idr_pct_min">IDR%</label>
          <input type="number" id="idr_pct_min" name="idr_pct_min" step="0.1" min="0" max="100" value="{{ min_idr_pct if min_idr_pct is not none else '' }}" placeholder="min" />
          <span class="range-separator">to</span>
          <input type="number" id="idr_pct_max" name="idr_pct_max" step="0.1" min="0" max="100" value="{{ max_idr_pct if max_idr_pct is not none else '' }}" placeholder="max" />
          <label for="cc_pct_min">CC%</label>
          <input type="number" id="cc_pct_min" name="cc_pct_min" step="0.1" min="0" max="100" value="{{ min_cc_pct if min_cc_pct is not none else '' }}" placeholder="min" />
          <span class="range-separator">to</span>
          <input type="number" id="cc_pct_max" name="cc_pct_max" step="0.1" min="0" max="100" value="{{ max_cc_pct if max_cc_pct is not none else '' }}" placeholder="max" />
          <label for="protein_len_min">Protein length (aa)</label>
          <input type="number" id="protein_len_min" name="protein_len_min" min="0" value="{{ min_protein_len if min_protein_len is not none else '' }}" placeholder="min" />
          <span class="range-separator">to</span>
          <input type="number" id="protein_len_max" name="protein_len_max" min="0" value="{{ max_protein_len if max_protein_len is not none else '' }}" placeholder="max" />
        </div>
        <div class="filter-row filter-row-keywords">
          <input type="text" id="domain_term" name="domain_term" value="{{ domain_term or '' }}" placeholder="Domain keyword" />
          <input type="text" id="location_term" name="location_term" value="{{ location_term or '' }}" placeholder="Location keyword" />
        </div>
        <div class="filter-row filter-row-actions">
          <label class="checkbox-inline" for="hide_missing_protein">
            <input type="checkbox" id="hide_missing_protein" name="hide_missing_protein" value="1" {% if hide_missing_protein %}checked{% endif %} />
            Hide entries with missing protein names
          </label>
          <button type="submit">Apply</button>
          {% if search or (search_mode and search_mode != 'all') or hide_missing_protein or min_idr_len is not none or min_cc_len is not none or min_protein_len is not none or max_protein_len is not none or min_idr_pct is not none or max_idr_pct is not none or min_cc_pct is not none or max_cc_pct is not none or min_score is not none or source or uniprot_id or per_page != 25 or domain_term or location_term %}
            <a class="clear-filter" href="{{ url_for('supramolecular') }}">Clear</a>
          {% endif %}
        </div>
      </div>

      <div class="filter-card">
        <h3>PPI filter</h3>
        <div class="filter-row filter-row-primary">
          <label for="search"><span>Filter:</span></label>
          <input type="text" id="search" name="search" value="{{ search or '' }}" placeholder="Gene, UniProt ID, protein name, location..." />
          <label for="search_mode">Search field:</label>
          <select id="search_mode" name="search_mode">
            {% set current_mode = search_mode or 'all' %}
            {% for value, label in SEARCH_MODE_OPTIONS %}
              <option value="{{ value }}" {% if value == current_mode %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
          <label for="per_page">Per page:</label>
          <select id="per_page" name="per_page">
            {% for option in [10,25,50,100] %}
              <option value="{{ option }}" {% if option == per_page %}selected{% endif %}>{{ option }}</option>
            {% endfor %}
          </select>
          <label for="source">Source</label>
          <select name="source" id="source">
            <option value="" {% if not source %}selected{% endif %}>All</option>
            <option value="biogrid" {% if source == "biogrid" %}selected{% endif %}>BioGRID (multi-validated)</option>
            <option value="string" {% if source == "string" %}selected{% endif %}>STRING (&gt;700)</option>
          </select>
        </div>
        <div class="filter-row filter-row-secondary">
          <label for="uniprot">UniProt ID</label>
          <input type="text" id="uniprot" name="uniprot" value="{{ uniprot_id or '' }}" placeholder="e.g. O15083" />
          <label for="score_min">Min STRING score</label>
          <input type="number" id="score_min" name="score_min" value="{{ min_score if min_score is not none else '' }}" min="0" step="1" />
        </div>
        <div class="filter-row filter-row-actions">
          <label class="checkbox-inline" for="require_both_sources">
            <input type="checkbox" id="require_both_sources" name="require_both_sources" value="1" {% if require_both_sources %}checked{% endif %} />
            Only pairs present in both BioGRID and STRING
          </label>
        </div>
      </div>
    </form>
  </div>

  <p class="meta">Showing {{ start_item }} – {{ end_item }} of {{ total_items }} pairs.</p>

  <table class="results-table">
    <thead>
      <tr>
        <th class="col-narrow">Source</th>
        <th class="col-narrow">UniProt A</th>
        <th class="col-narrow">Gene A</th>
        <th class="col-small">IDR % A</th>
        <th class="col-small">CC % A</th>
        <th class="col-narrow">UniProt B</th>
        <th class="col-narrow">Gene B</th>
        <th class="col-small">IDR % B</th>
        <th class="col-small">CC % B</th>
        <th class="col-small">Score</th>
      </tr>
    </thead>
    <tbody>
      {% if records %}
        {% for r in records %}
        <tr>
          <td class="col-narrow">{{ r.source }}</td>
          <td class="col-narrow"><a href="{{ url_for('protein_detail', uniprot_id=r.a_id, return_to=request.full_path) }}">{{ r.a_id }}</a></td>
          <td class="col-narrow">{{ r.a_gene }}</td>
          <td class="col-small">{{ "%.2f"|format(r.a_idr_pct) if r.a_idr_pct is not none else "" }}</td>
          <td class="col-small">{{ "%.2f"|format(r.a_cc_pct) if r.a_cc_pct is not none else "" }}</td>
          <td class="col-narrow"><a href="{{ url_for('protein_detail', uniprot_id=r.b_id, return_to=request.full_path) }}">{{ r.b_id }}</a></td>
          <td class="col-narrow">{{ r.b_gene }}</td>
          <td class="col-small">{{ "%.2f"|format(r.b_idr_pct) if r.b_idr_pct is not none else "" }}</td>
          <td class="col-small">{{ "%.2f"|format(r.b_cc_pct) if r.b_cc_pct is not none else "" }}</td>
          <td class="col-small">{{ r.combined_score if r.combined_score is not none else "—" }}</td>
        </tr>
        {% endfor %}
      {% else %}
        <tr><td colspan="10">No pairs found for the current filters.</td></tr>
      {% endif %}
    </tbody>
  </table>

  {% if total_pages > 1 %}
  <div class="pagination">
    {% if show_first %}<a href="{{ page_url(1) }}">1</a>{% endif %}
    {% for num in page_numbers %}
      {% if num == page %}
        <span class="current">{{ num }}</span>
      {% else %}
        <a href="{{ page_url(num) }}">{{ num }}</a>
      {% endif %}
    {% endfor %}
    {% if show_last %}<a href="{{ page_url(total_pages) }}">{{ total_pages }}</a>{% endif %}
  </div>
  {% endif %}
{% endblock %}
